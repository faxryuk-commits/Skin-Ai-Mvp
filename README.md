# Skin AI (MVP)

Информационный Telegram-бот для базового анализа кожи по селфи. MVP состоит из двух сервисов: Telegram-бот (`bot/`) и FastAPI-бэкенд для инференса (`api/`). Анализ выполняется через OpenAI Vision + простые эвристические метрики, а рекомендации комбинируются с правилами из `api/rules/product_rules.json`.

## Архитектура

- `bot/` — бот на aiogram 3, принимает фото, отправляет на API и форматирует отчёт.
- `api/` — FastAPI-сервис с асинхронным вызовом OpenAI Vision и базовыми метриками (Laplacian variance, HSV и т.д.).
- `shared/` — общие типы (используются опционально).
- `railway.toml` — конфигурация деплоя на Railway (два сервиса: `api` и `bot`).

## Быстрый старт

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r api/requirements.txt
pip install -r bot/requirements.txt
```

Создайте `.env` на основе `.env.example` и заполните ключи:

```
BOT_TOKEN=...
API_BASE_URL=http://127.0.0.1:8000
OPENAI_API_KEY=...
```

### Запуск API локально

```bash
cd api
uvicorn main:app --reload
```

Проверка здоровья:

```bash
curl http://127.0.0.1:8000/health
```

### Запуск бота локально

```bash
cd bot
python main.py
```

В Telegram отправьте фото боту и дождитесь отчёта.

## Railway деплой

1. Форкните репозиторий и подключите в Railway (`New Project` → `Deploy from Repo`).
2. Railway автоматически создаст два сервиса по папкам `api` и `bot`.
3. Для `api` задайте переменные: `OPENAI_API_KEY`, `OPENAI_MODEL_VISION`, опционально `DATABASE_URL`.
4. После деплоя API скопируйте домен и запишите его в переменную `API_BASE_URL` для сервиса `bot`.
5. Для бота задайте `BOT_TOKEN` (выдаёт BotFather) и `API_BASE_URL`.

## Хранение данных

- По умолчанию фотографии не сохраняются. При необходимости можно включить `STORE_IMAGES=true` и реализовать сохранение в БД в `api/db.py`.
- Результаты анализа можно писать в Postgres (поддержка заготовлена через `sqlalchemy`), но в MVP опционально.

## Безопасность и UX

- Возрастное ограничение 16+: текст геита встроен в сообщения бота.
- Бот дружелюбно напоминает про отказ от медицинских диагнозов и про согласие.
- В случае плохого качества фото API возвращает 422, бот просит переснять.

## Дальнейшие шаги

- Внедрить real face detection (Mediapipe) в `api/models/face_utils.py`.
- Добавить PDF-отчёты и напоминания в боте.
- Расширить метрики (пигментация, текстура) и подключить видео.

## Object Storage

API сохраняет оригинальные изображения в S3-совместимое хранилище. Укажите переменные `STORAGE_*` в `.env`/Railway, и предоставьте публичный URL или используйте генерируемые presigned ссылки.
